trigger:
  - production

variables:
  - name: major
    value: 0
  - name: minor
    value: 1
  - name: patch
    value: 0

name: $(major).$(minor).$(patch)-$(Rev:r)

stages:
  - stage: deploy
    displayName: Deploy
    condition:
      not(eq(variables['build.reason'], 'PullRequest'))
    jobs:
      - job: updateStaging
        displayName: Update Staging
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: Kubernetes@1
            displayName: Refresh InitializrApi
            inputs:
              connectionType: Kubernetes Service Connection
              kubernetesServiceEndpoint: SteeltoeProductionAKS
              command: exec
              arguments: deployment/initializr-cli -- http http://initializr-api/actuator/refresh
              namespace: initializr
  - stage: qa
    displayName: QA
    dependsOn: deploy
    jobs:
      - job: runSystemTests
        displayName: Run System Tests
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: UseDotNet@2
            displayName: Install DotNet SDK 5.0
            inputs:
              packageType: sdk
              version: 5.0.x
          - task: UseDotNet@2
            displayName: Install DotNet SDK 3.1
            inputs:
              packageType: sdk
              version: 3.1.x
          - task: UseDotNet@2
            displayName: Install DotNet SDK 2.1
            inputs:
              packageType: sdk
              version: 2.1.x
          - task: DotNetCoreCLI@2
            displayName: dotnet restore
            inputs:
              command: restore
              feedsToUse: config
              nugetConfigPath: NuGet.Config
          - task: DotNetCoreCLI@2
            displayName: dotnet build
            inputs:
              command: build
              arguments: --no-restore
          - task: DotNetCoreCLI@2
            displayName: dotnet test
            inputs:
              command: test
              arguments: --no-build
